<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCO Gestor Calend√°rio de Eventos Tecnol√≥gicos e Industriais</title>
    <!-- Carrega o Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configura√ß√£o de fonte padr√£o e tema escuro -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Fundo escuro */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            color: #d1d5db; /* Cor de texto padr√£o clara */
        }
        /* Estiliza√ß√£o para a seta do select em navegadores que suportam */
        #region-filter {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23818cf8' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem; /* Espa√ßo para a seta */
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="w-full max-w-5xl bg-gray-900 shadow-2xl rounded-3xl p-6 sm:p-10 transition-all duration-300">
        <!-- Cabe√ßalho Principal REESTRUTURADO -->
        <header class="mb-10">
            <!-- T√≠tulo Principal -->
            <h1 class="text-3xl sm:text-5xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-indigo-300 to-purple-400 drop-shadow-lg transition-colors duration-500 mb-4">
                FCO Gestor Calend√°rio
            </h1>
            
            <!-- Novo Bloco de Filtro, Contadores e Controles de Navega√ß√£o -->
            <div class="flex flex-col space-y-4">
                
                <!-- 1. GRUPO: FILTRO E CONTAGEM (Responsivo) -->
                <div class="flex flex-wrap items-center gap-3"> 
                    
                    <!-- FILTRO DE REGI√ÉO -->
                    <select id="region-filter" 
                            class="px-4 py-2 bg-gray-800 text-indigo-400 rounded-xl border-2 border-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-md hover:border-indigo-500 transition-all duration-300 appearance-none cursor-pointer" 
                            onchange="setFilterRegion(this.value)">
                        <option value="all" class="bg-gray-900 text-gray-400">Todas as Regi√µes</option>
                        <option value="SC" class="bg-gray-900 text-indigo-300">Santa Catarina (SC)</option>
                        <option value="RS" class="bg-gray-900 text-indigo-300">Rio Grande do Sul (RS)</option>
                        <option value="PR" class="bg-gray-900 text-indigo-300">Paran√° (PR)</option>
                    </select>
                    
                    <!-- R√ìTULO DE EVENTOS -->
                    <span class="text-gray-300 text-sm font-semibold hidden sm:inline-block border-r border-gray-700 pr-3">Eventos:</span>
                    
                    <!-- NOVOS CONTADORES REGIONAIS DIN√ÇMICOS -->
                    <div id="counter-sc" data-region="SC" title="Total de eventos em Santa Catarina" class="region-counter flex items-center justify-center h-8 px-3 rounded-xl text-xs font-bold transition-all duration-300">
                        SC: 0
                    </div>
                    <div id="counter-rs" data-region="RS" title="Total de eventos no Rio Grande do Sul" class="region-counter flex items-center justify-center h-8 px-3 rounded-xl text-xs font-bold transition-all duration-300">
                        RS: 0
                    </div>
                    <div id="counter-pr" data-region="PR" title="Total de eventos no Paran√°" class="region-counter flex items-center justify-center h-8 px-3 rounded-xl text-xs font-bold transition-all duration-300">
                        PR: 0
                    </div>
                </div>

                <!-- 2. STATUS E BOT√ÉO VOLTAR (Agrupados e alinhados √† direita) -->
                <div class="flex justify-between sm:justify-end items-center space-x-3 text-sm text-gray-400 mt-2 sm:mt-0">
                    <span id="user-info" class="hidden sm:inline-block">Aguardando autentica√ß√£o...</span>
                    <!-- Bot√£o de Voltar (Vis√≠vel apenas na view mensal) -->
                    <button id="back-button" class="hidden px-4 py-2 bg-gray-700 text-gray-200 rounded-xl font-medium shadow hover:bg-gray-600 transition-colors" onclick="setView('annual')">
                        &larr; Voltar
                    </button>
                </div>
            </div>
        </header>

        <!-- Container do Calend√°rio (Anual ou Mensal) -->
        <div id="calendar-container">
            <!-- Conte√∫do gerado via JS -->
        </div>
    </div>

    <!-- Modal para Adicionar Eventos (Tema Escuro) -->
    <div id="event-modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center p-4 z-50">
        <div class="bg-gray-800 text-gray-100 p-6 rounded-2xl shadow-2xl w-full max-w-md transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
            <h2 id="modal-title" class="text-2xl font-bold mb-4 text-indigo-400">Adicionar Novo Evento</h2>
            <p id="modal-date-info" class="text-gray-400 mb-4"></p>

            <form id="event-form">
                <input type="hidden" id="event-month">
                <input type="hidden" id="event-day">

                <div class="mb-4">
                    <label for="event-text" class="block text-sm font-medium text-gray-300 mb-1">Descri√ß√£o do Evento:</label>
                    <input type="text" id="event-text" required placeholder="Ex: Confer√™ncia Ind√∫stria 4.0" class="w-full p-3 border border-gray-600 bg-gray-700 text-white rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                </div>
                
                <div class="mb-4">
                    <label for="event-link" class="block text-sm font-medium text-gray-300 mb-1">Link (Opcional):</label>
                    <input type="url" id="event-link" placeholder="https://www.site-do-evento.com.br" class="w-full p-3 border border-gray-600 bg-gray-700 text-white rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                </div>

                <div class="mb-6">
                    <label for="event-region" class="block text-sm font-medium text-gray-300 mb-1">Regi√£o do Evento:</label>
                    <select id="event-region" required class="w-full p-3 border border-gray-600 bg-gray-700 text-white rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                        <option value="" class="bg-gray-900">Selecione a Regi√£o</option>
                        <option value="SC" class="bg-gray-900">Santa Catarina (SC)</option>
                        <option value="RS" class="bg-gray-900">Rio Grande do Sul (RS)</option>
                        <option value="PR" class="bg-gray-900">Paran√° (PR)</option>
                    </select>
                </div>

                <div id="current-events" class="mb-4 p-3 bg-gray-700 rounded-xl max-h-40 overflow-y-auto hidden">
                    <h3 class="font-semibold text-indigo-400 mb-2">Eventos Existentes:</h3>
                    <ul id="event-list" class="space-y-2 text-gray-200">
                        <!-- Lista de eventos ser√° populada aqui -->
                    </ul>
                </div>
                
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" onclick="closeModal()" class="px-5 py-2 border border-gray-600 bg-gray-700 rounded-xl text-gray-200 hover:bg-gray-600 transition-colors">Cancelar</button>
                    <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-xl font-semibold hover:bg-indigo-700 transition-colors shadow-md">Salvar Evento</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs (JS L√≥gica) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Ativa o log de depura√ß√£o do Firestore
        setLogLevel('Debug');

        // --- Vari√°veis Globais de Configura√ß√£o do Ambiente ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        
        // --- Vari√°veis de Estado da Aplica√ß√£o ---
        let currentView = 'annual'; // 'annual' ou 'monthly'
        let selectedMonth = 0;      // 0 = Janeiro, 11 = Dezembro
        let events = {};            // Armazena os dados de eventos { monthIndex: { day: [{text, link, region}], ... }, ... }
        let filterRegion = 'all';   // Regi√£o atualmente selecionada para filtro ('all', 'SC', 'RS', 'PR')
        
        const calendarContainer = document.getElementById('calendar-container');
        const backButton = document.getElementById('back-button');
        const userInfoSpan = document.getElementById('user-info');
        const eventModal = document.getElementById('event-modal');
        const modalContent = document.getElementById('modal-content');
        const currentEventsDiv = document.getElementById('current-events');
        const eventListUl = document.getElementById('event-list');
        const eventLinkInput = document.getElementById('event-link');
        const eventRegionInput = document.getElementById('event-region'); 

        // Refer√™ncias para os novos contadores
        const counterSC = document.getElementById('counter-sc');
        const counterRS = document.getElementById('counter-rs');
        const counterPR = document.getElementById('counter-pr');


        const MONTH_NAMES = [
            "Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho",
            "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
        ];
        const DAY_NAMES = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];
        const DAYS_IN_MONTH = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        const YEAR = 2026;
        
        // Constantes para Proximidade
        const PROXIMITY_DAYS = 7; // ATUALIZADO para 7 dias
        const ONE_DAY_MS = 1000 * 60 * 60 * 24;

        /**
         * Retorna a refer√™ncia do documento do Firestore para os eventos do calend√°rio compartilhado.
         * Caminho: /artifacts/{appId}/public/data/2026_calendar_events/shared_events_data
         */
        const getEventsDocRef = () => {
            const collectionPath = `/artifacts/${appId}/public/data/2026_calendar_events`;
            return doc(db, collectionPath, 'shared_events_data');
        };
        
        /**
         * Inicializa o Firebase e a Autentica√ß√£o.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Configura√ß√£o do Firebase n√£o encontrada. Usando modo de simula√ß√£o.");
                userInfoSpan.textContent = "Modo de simula√ß√£o (sem persist√™ncia)";
                isAuthReady = true;
                renderApp();
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 1. Configura o listener de estado de autentica√ß√£o
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userInfoSpan.textContent = `Usu√°rio ID: ${userId}`;
                        isAuthReady = true;
                        console.log("Autentica√ß√£o completa. UID:", userId);
                        // Inicia o listener de dados ap√≥s a autentica√ß√£o
                        setupDataListener();
                    } else {
                        userInfoSpan.textContent = "N√£o autenticado";
                        isAuthReady = true;
                        renderApp();
                    }
                });

                // 2. Realiza o login (com token ou anonimamente)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Erro ao inicializar Firebase ou autenticar:", error);
                userInfoSpan.textContent = "Erro de autentica√ß√£o! Verifique o console.";
                isAuthReady = true;
                renderApp(); 
            }
        }

        /**
         * Configura o listener em tempo real para os eventos.
         */
        function setupDataListener() {
            if (!isAuthReady || !userId) return;

            const docRef = getEventsDocRef(); 

            // Listener em tempo real (onSnapshot)
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    // Atualiza o objeto 'events' com os dados do Firestore
                    events = docSnap.data().data || {};
                    console.log("Eventos atualizados recebidos:", events);
                } else {
                    events = {};
                    console.log("Documento de eventos n√£o encontrado, inicializando vazio.");
                }
                // Renderiza o calend√°rio com os novos dados
                renderApp();
            }, (error) => {
                console.error("Erro no listener de eventos do Firestore:", error);
            });
        }

        /**
         * Salva o objeto de eventos atual no Firestore.
         */
        async function saveEventsToFirestore() {
            if (!isAuthReady || !userId) {
                console.warn("Autentica√ß√£o n√£o conclu√≠da. N√£o foi poss√≠vel salvar os dados.");
                return;
            }
            
            const docRef = getEventsDocRef(); 

            try {
                // Tenta definir o documento.
                await setDoc(docRef, { data: events }, { merge: false }); 
                console.log("Eventos salvos com sucesso no Firestore.");
            } catch (error) {
                console.error("Erro ao salvar eventos no Firestore:", error);
            }
        }

        /**
         * Calcula a contagem total de eventos para cada regi√£o (SC, RS, PR).
         * @returns {{SC: number, RS: number, PR: number}} Contagens regionais.
         */
        function calculateRegionalCounts() {
            const counts = { SC: 0, RS: 0, PR: 0 };

            // Itera sobre todos os meses
            for (const monthIndex in events) {
                const monthEvents = events[monthIndex];
                // Itera sobre todos os dias
                for (const dayKey in monthEvents) {
                    const dayEvents = monthEvents[dayKey];
                    // Itera sobre os eventos do dia
                    dayEvents.forEach(eventObj => {
                        const region = eventObj.region;
                        if (counts.hasOwnProperty(region)) {
                            counts[region]++;
                        }
                    });
                }
            }
            return counts;
        }
        
        /**
         * Atualiza o texto e a apar√™ncia (cores e destaque) dos contadores regionais.
         * @param {{SC: number, RS: number, PR: number}} counts - Contagens regionais.
         */
        function updateRegionalCounterStyle(counts) {
            const regions = ['SC', 'RS', 'PR'];
            
            regions.forEach(region => {
                const element = document.getElementById(`counter-${region.toLowerCase()}`);
                const count = counts[region];
                
                element.textContent = `${region}: ${count}`;
                
                // Classes comuns (reset) - Adiciona classes de interatividade
                element.className = 'region-counter flex items-center justify-center h-8 px-3 rounded-xl text-xs font-bold transition-all duration-300 cursor-pointer hover:scale-[1.05] hover:shadow-xl';
                
                let styleClasses = '';
                
                const isFiltered = filterRegion === region;
                
                if (isFiltered) {
                    // Destaque M√ÅXIMO (Filtro ativo)
                    styleClasses = 'bg-indigo-600 text-white border-2 border-indigo-300 ring-2 ring-indigo-400 shadow-xl';
                } else if (count > 0) {
                    // Destaque Intermedi√°rio (Eventos existem, mas n√£o √© o filtro ativo)
                    styleClasses = 'bg-indigo-700/50 text-indigo-300 border border-indigo-600 hover:bg-indigo-700/70 hover:border-indigo-500';
                } else {
                    // Destaque M√≠nimo (Contagem zero)
                    styleClasses = 'bg-gray-800 text-gray-400 border border-gray-700 hover:bg-gray-700 hover:border-gray-600';
                }
                
                element.className += ' ' + styleClasses;
                
                // Adiciona a fun√ß√£o de clique para aplicar o filtro
                element.setAttribute('onclick', `setFilterRegion('${region}')`);
            });
        }


        /**
         * Define a regi√£o de filtro e renderiza a aplica√ß√£o.
         * Implementa a l√≥gica de toggle: se clicar no mesmo filtro, ele reseta para 'all'.
         * @param {string} region - A regi√£o a ser filtrada ('all', 'SC', 'RS', 'PR').
         */
        window.setFilterRegion = (region) => {
            // Se a regi√£o clicada √© a mesma que o filtro atual, reseta para 'all'
            if (filterRegion === region && region !== 'all') {
                filterRegion = 'all';
            } else {
                filterRegion = region;
            }
            
            // Atualiza o dropdown de filtro (caso a mudan√ßa tenha vindo do contador)
            document.getElementById('region-filter').value = filterRegion;

            // Volta para a visualiza√ß√£o anual ao aplicar um novo filtro ou ao limpar o filtro
            if (currentView === 'monthly') {
                currentView = 'annual';
            }
            renderApp();
        };

        /**
         * Renderiza a aplica√ß√£o com base na view atual.
         */
        function renderApp() {
            // 1. Atualiza o dropdown de filtro (caso a mudan√ßa tenha vindo do contador)
            document.getElementById('region-filter').value = filterRegion;
            
            // 2. Calcula e Atualiza os Contadores com Estilos Din√¢micos
            const regionalCounts = calculateRegionalCounts();
            updateRegionalCounterStyle(regionalCounts);
            
            // 3. Renderiza a visualiza√ß√£o (Anual ou Mensal)
            backButton.classList.toggle('hidden', currentView === 'annual');
            if (currentView === 'annual') {
                renderAnnualView();
            } else {
                renderMonthlyView(selectedMonth);
            }
        }
        
        /**
         * Altera a view (anual/mensal) e renderiza.
         * @param {string} view - 'annual' ou 'monthly'
         * @param {number} [monthIndex] - O √≠ndice do m√™s (0-11) para a view 'monthly'.
         */
        window.setView = (view, monthIndex = 0) => {
            currentView = view;
            if (view === 'monthly') {
                selectedMonth = monthIndex;
            }
            renderApp();
        };

        /**
         * Gera o HTML para a view anual (12 meses).
         */
        function renderAnnualView() {
            // Determina a data atual efetiva para o teste de proximidade (ping vermelho)
            let today = new Date();
            today.setHours(0, 0, 0, 0); 
            
            // O bloco de teste de data tempor√°rio foi removido.

            calendarContainer.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    ${MONTH_NAMES.map((name, index) => {
                        const monthEvents = events[index];
                        
                        let totalEventsCount = 0;
                        let hasProximateEvent = false;

                        // 1. Processa todos os dias do m√™s para contagem e proximidade
                        if (monthEvents) {
                            for (const dayKey in monthEvents) {
                                const day = parseInt(dayKey);
                                const dayEvents = monthEvents[dayKey];

                                // Filtra eventos por regi√£o
                                const filteredDayEvents = dayEvents.filter(eventObj => 
                                    filterRegion === 'all' || eventObj.region === filterRegion
                                );
                                
                                totalEventsCount += filteredDayEvents.length;
                                
                                // 2. Checa Proximidade (Pr√≥ximos 7 dias)
                                if (filteredDayEvents.length > 0 && !hasProximateEvent) {
                                    const eventDate = new Date(YEAR, index, day);
                                    const timeDiff = eventDate.getTime() - today.getTime();
                                    const diffDays = Math.ceil(timeDiff / ONE_DAY_MS);
                                    
                                    if (diffDays >= 0 && diffDays <= PROXIMITY_DAYS) {
                                        hasProximateEvent = true;
                                        // Otimiza√ß√£o: Paramos o loop assim que um evento pr√≥ximo √© encontrado
                                        break; 
                                    }
                                }
                            }
                        }
                        
                        // --- DEFINI√á√ÉO DE ESTILOS ---
                        const nonEventStyle = 'border-gray-700 hover:bg-gray-800 hover:scale-[1.03] hover:-translate-y-1 hover:shadow-2xl shadow-gray-800/50';
                        
                        // Estilo para M√™s com Eventos Pr√≥ximos (Ping Vermelho)
                        const proximateStyle = 'border-red-500 bg-red-900/50 shadow-xl shadow-red-900/50 transform scale-[1.03] hover:scale-[1.05] hover:-translate-y-2';
                        
                        // Estilo para M√™s com Eventos Futuros (Ping √çndigo Est√°tico)
                        const eventStyle = 'border-indigo-500 bg-indigo-900/50 shadow-xl shadow-indigo-900/50 transform scale-[1.03] hover:scale-[1.05] hover:-translate-y-2';
                        
                        const cardStyle = hasProximateEvent 
                            ? proximateStyle 
                            : (totalEventsCount > 0 ? eventStyle : nonEventStyle);
                        
                        // --- DEFINI√á√ÉO DO INDICADOR ---
                        let indicatorHTML = '';
                        let eventText;

                        if (hasProximateEvent) {
                            // Indicador Vermelho Pulsante (PING)
                            indicatorHTML = `
                                <span class="absolute top-2 right-2 flex h-3 w-3" title="Eventos Pr√≥ximos no M√™s! (Pr√≥ximos ${PROXIMITY_DAYS} dias)">
                                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-3 w-3 bg-red-600"></span>
                                </span>`;
                            eventText = `EVENTO PR√ìXIMO! (${totalEventsCount} Evento${totalEventsCount !== 1 ? 's' : ''})`;
                        } else if (totalEventsCount > 0) {
                            // Indicador √çndigo Est√°tico
                            indicatorHTML = `
                                <span class="absolute top-2 right-2 flex h-3 w-3" title="${totalEventsCount} Eventos agendados">
                                    <span class="relative inline-flex rounded-full h-3 w-3 bg-indigo-600"></span>
                                </span>`;
                            eventText = `${totalEventsCount} Evento${totalEventsCount !== 1 ? 's' : ''} Encontrado${totalEventsCount !== 1 ? 's' : ''}`;
                        } else {
                            // Sem Eventos
                            eventText = (filterRegion !== 'all' ? `Sem eventos em ${filterRegion}` : 'Clique para agendar eventos');
                        }


                        return `
                            <div 
                                class="month-card relative p-6 border-2 rounded-2xl cursor-pointer transition-all duration-300 ${cardStyle} text-gray-100"
                                onclick="setView('monthly', ${index})"
                            >
                                ${indicatorHTML}
                                <h2 class="text-xl font-bold text-gray-100">${name}</h2>
                                <p class="text-sm text-gray-400 mt-1">${DAYS_IN_MONTH[index]} dias</p>
                                <p class="text-sm font-semibold ${hasProximateEvent ? 'text-red-300' : 'text-indigo-400'} mt-3">${eventText}</p>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        /**
         * Gera o HTML para a view mensal (dias do m√™s selecionado).
         * @param {number} monthIndex - O √≠ndice do m√™s (0-11).
         */
        function renderMonthlyView(monthIndex) {
            const monthName = MONTH_NAMES[monthIndex];
            const daysInMonth = DAYS_IN_MONTH[monthIndex];
            const firstDayOfMonth = new Date(YEAR, monthIndex, 1).getDay(); // 0 (Dom) a 6 (S√°b)
            
            // Container principal do m√™s (Indigo)
            let html = `<h2 class="text-3xl font-bold mb-6 text-indigo-400">${monthName}, ${YEAR}</h2>`;
            
            // Cabe√ßalho dos dias da semana (Dark Mode)
            html += `
                <div class="grid grid-cols-7 text-center font-semibold text-sm text-gray-400 border-b border-gray-700 pb-2 mb-2">
                    ${DAY_NAMES.map(day => `<div class="p-2">${day}</div>`).join('')}
                </div>
            `;

            // Grid dos dias
            html += '<div class="grid grid-cols-7 gap-1 sm:gap-3">';
            
            // Preenche espa√ßos vazios (padding days)
            for (let i = 0; i < firstDayOfMonth; i++) {
                html += `<div class="p-2 aspect-square"></div>`;
            }
            
            let today = new Date();
            today.setHours(0, 0, 0, 0); // Normaliza para o in√≠cio do dia

            // O bloco de teste de data tempor√°rio foi removido.

            // Preenche os dias do m√™s
            for (let day = 1; day <= daysInMonth; day++) {
                const dayKey = String(day);
                const dayEvents = events[monthIndex]?.[dayKey] || [];
                
                // Filtra os eventos do dia com base na regi√£o para destaque
                const filteredDayEvents = dayEvents.filter(eventObj => 
                    filterRegion === 'all' || eventObj.region === filterRegion
                );
                
                const hasFilteredEvents = filteredDayEvents.length > 0;
                
                // --- L√≥gica de Proximidade (Pr√≥ximos 7 dias) ---
                const eventDate = new Date(YEAR, monthIndex, day);
                
                const timeDiff = eventDate.getTime() - today.getTime();
                // Calcula a diferen√ßa em dias (arredonda para cima para garantir que o dia atual seja >= 0)
                const diffDays = Math.ceil(timeDiff / ONE_DAY_MS);
                
                // √â pr√≥ximo se tiver eventos filtrados, estiver no futuro (ou hoje) e dentro do limite (7 dias)
                const isProximate = hasFilteredEvents && diffDays >= 0 && diffDays <= PROXIMITY_DAYS;
                // --------------------------------------------------

                // Estilos base com anima√ß√£o de hover
                let dayStyle = 'p-2 sm:p-3 text-center rounded-xl cursor-pointer transition-all duration-200 relative aspect-square flex flex-col items-center justify-center shadow-md';
                
                // Estilos para o dia atual (Dark Mode)
                const isCurrentDay = today.getFullYear() === YEAR && today.getMonth() === monthIndex && today.getDate() === day;
                
                let titleText;
                let indicatorHTML = '';

                if (isCurrentDay) {
                    dayStyle += ' border-2 border-red-500 bg-red-900 font-bold text-red-200 shadow-xl';
                    titleText = 'Hoje - Clique para ver/adicionar eventos';
                } else if (isProximate) {
                     // Estilo de fundo vermelho escuro + Borda
                    dayStyle += ' bg-red-800/70 hover:bg-red-700 border-2 border-red-600 font-medium text-white shadow-lg hover:scale-[1.03] hover:shadow-xl';
                    
                    // Indicador Vermelho Pulsante (Ping)
                    indicatorHTML = `
                        <span class="absolute top-1 right-1 flex h-3 w-3" title="Evento Pr√≥ximo (Faltam ${diffDays} dias)">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-red-600"></span>
                        </span>
                    `;
                    titleText = `Evento Pr√≥ximo (Faltam ${diffDays} dias) - Clique para ver detalhes`;
                } else if (hasFilteredEvents) {
                    // Estilo normal para evento (Indigo)
                    dayStyle += ' bg-indigo-800/70 hover:bg-indigo-700 border-2 border-indigo-600 font-medium text-white shadow-lg hover:scale-[1.03] hover:shadow-xl';
                    
                    // Indicador est√°tico Indigo (Bolinha)
                    indicatorHTML = `
                        <span class="absolute top-1 right-1 flex h-3 w-3" title="${filteredDayEvents.length} Evento(s) na regi√£o ${filterRegion === 'all' ? 'selecionada' : filterRegion}">
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-indigo-600"></span>
                        </span>
                    `;
                    titleText = `${filteredDayEvents.length} Evento(s) - Clique para ver detalhes`;
                } else {
                    // Hover aprimorado para dias normais
                    dayStyle += ' bg-gray-700 hover:bg-gray-600 text-gray-100 hover:scale-[1.03] hover:shadow-xl';
                    titleText = 'Clique para adicionar evento';
                }

                html += `
                    <div 
                        class="${dayStyle}" 
                        onclick="openEventModal(${monthIndex}, ${day})"
                        title="${titleText}"
                    >
                        <span class="text-lg leading-none">${day}</span>
                        ${indicatorHTML}
                    </div>
                `;
            }

            html += '</div>';
            calendarContainer.innerHTML = html;
        }
        
        /**
         * Abre o modal para adicionar/visualizar eventos de um dia.
         * @param {number} monthIndex - √çndice do m√™s (0-11).
         * @param {number} day - Dia do m√™s (1-31).
         */
        window.openEventModal = (monthIndex, day) => {
            document.getElementById('event-month').value = monthIndex;
            document.getElementById('event-day').value = day;
            document.getElementById('modal-date-info').textContent = `${DAY_NAMES[new Date(YEAR, monthIndex, day).getDay()]}, ${day} de ${MONTH_NAMES[monthIndex]} de ${YEAR}`;
            document.getElementById('event-text').value = '';
            document.getElementById('event-link').value = ''; 
            document.getElementById('event-region').value = ''; 
            
            // Popula a lista de eventos (mostra TODOS os eventos, independentemente do filtro)
            const dayKey = String(day);
            const dayEvents = events[monthIndex]?.[dayKey] || [];
            
            eventListUl.innerHTML = ''; 
            if (dayEvents.length > 0) {
                currentEventsDiv.classList.remove('hidden');
                dayEvents.forEach((eventObj, index) => {
                    const link = eventObj.link && eventObj.link.trim() !== '' ? eventObj.link : null;
                    const linkIcon = link
                        ? `<a href="${link}" target="_blank" class="text-indigo-400 hover:text-indigo-300 ml-2" title="Abrir Link">üîó</a>`
                        : '';
                        
                    const regionBadge = eventObj.region 
                        ? `<span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-indigo-600 text-white">${eventObj.region}</span>`
                        : '';

                    // Destaque se o evento for o que est√° sendo filtrado
                    const isFiltered = filterRegion === 'all' || eventObj.region === filterRegion;
                    const itemStyle = isFiltered ? 'bg-indigo-700/60 border-indigo-500' : 'bg-gray-600 border-gray-500';


                    eventListUl.innerHTML += `
                        <li class="flex justify-between items-center ${itemStyle} p-2 rounded-lg border">
                            <span class="flex items-center text-gray-100">
                                ${eventObj.text} 
                                ${linkIcon}
                            </span>
                            <div class="flex items-center space-x-2">
                                ${regionBadge}
                                <button 
                                    type="button" 
                                    class="text-red-400 hover:text-red-500 text-lg leading-none transition-colors"
                                    onclick="deleteEvent(${monthIndex}, ${day}, ${index})"
                                    title="Excluir Evento"
                                >&times;</button>
                            </div>
                        </li>
                    `;
                });
            } else {
                currentEventsDiv.classList.add('hidden');
            }

            // Exibe o modal com anima√ß√£o
            eventModal.classList.remove('hidden');
            eventModal.classList.add('flex');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        };

        /**
         * Fecha o modal de eventos.
         */
        window.closeModal = () => {
            // Esconde o modal com anima√ß√£o
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                eventModal.classList.remove('flex');
                eventModal.classList.add('hidden');
            }, 300);
        };

        // Adiciona a funcionalidade de fechar o modal ao clicar fora do painel
        eventModal.addEventListener('click', (e) => {
            if (e.target === eventModal) {
                closeModal();
            }
        });

        /**
         * Adiciona um novo evento ao estado e salva no Firestore.
         */
        document.getElementById('event-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const monthIndex = parseInt(document.getElementById('event-month').value);
            const day = parseInt(document.getElementById('event-day').value);
            const eventText = document.getElementById('event-text').value.trim();
            const eventLink = document.getElementById('event-link').value.trim();
            const eventRegion = document.getElementById('event-region').value.trim(); 
            
            if (!eventText || !eventRegion) { 
                console.error("Descri√ß√£o e Regi√£o do evento s√£o obrigat√≥rias.");
                return;
            }

            // Cria o objeto do novo evento 
            const newEvent = {
                text: eventText,
                link: eventLink,
                region: eventRegion
            };

            // Garante que o objeto do m√™s exista
            if (!events[monthIndex]) {
                events[monthIndex] = {};
            }

            // Garante que a lista de eventos do dia exista
            const dayKey = String(day);
            if (!events[monthIndex][dayKey]) {
                events[monthIndex][dayKey] = [];
            }

            // Adiciona o novo evento (objeto)
            events[monthIndex][dayKey].push(newEvent);
            
            // Salva no Firestore
            await saveEventsToFirestore();

            // Atualiza a visualiza√ß√£o no modal e no calend√°rio
            closeModal();
            renderApp();
        });

        /**
         * Deleta um evento do estado (baseado no √≠ndice dentro do array do dia) e salva no Firestore.
         * @param {number} monthIndex - √çndice do m√™s (0-11).
         * @param {number} day - Dia do m√™s (1-31).
         * @param {number} eventIndex - O √≠ndice do evento dentro do array do dia.
         */
        window.deleteEvent = async (monthIndex, day, eventIndex) => {
            // SUBSTITUI√á√ÉO DE CONFIRM(): Simula a confirma√ß√£o imediata
            const proceed = true; 

            if (proceed) {
                const dayKey = String(day);
                if (events[monthIndex] && events[monthIndex][dayKey]) {
                    
                    // Remove o evento usando o √≠ndice
                    events[monthIndex][dayKey].splice(eventIndex, 1);
                    
                    // Limpa o dia e/ou o m√™s se estiverem vazios
                    if (events[monthIndex][dayKey].length === 0) {
                        delete events[monthIndex][dayKey];
                    }
                    if (Object.keys(events[monthIndex]).length === 0) {
                        delete events[monthIndex];
                    }

                    // Salva no Firestore
                    await saveEventsToFirestore();

                    // Fecha e reabre o modal para atualizar a lista
                    closeModal();
                    
                    // Verifica se o dia ainda tem eventos antes de reabrir
                    if (events[monthIndex] && events[monthIndex][dayKey] && events[monthIndex][dayKey].length > 0) {
                         openEventModal(monthIndex, day);
                    } else {
                        // Se n√£o tem mais eventos, renderiza o m√™s para remover o destaque do dia
                        renderApp(); 
                    }
                }
            } else {
                console.log("Exclus√£o cancelada.");
            }
        };

        // --- Inicia a Aplica√ß√£o ---
        window.onload = initializeFirebase;
    </script>

</body>
</html>
